
/** \file
	\authors John-Olof Nilsson
	\copyright Copyright (c) 2014 OpenShoe, Cre­ative Com­mons Attri­bu­tion 4.0 License
*/

#ifndef MIMU3333_H_
#define MIMU3333_H_

// SETTINGS BUFFERS
#define N 256u
#define LOG2N 8u
#define M 8u
#define LOG2M 3u
#define ZAZU_OFFSET 0

// SQRT TRACKING LIMIT
#define SQRT_TRK_C 2047

// SETTINGS STATIONARITY DETECTION
#define BIT_REDU_G 13u
#define BIT_REDU_F 13u
#define SR 1u
#define G2 67108864u
#define TWOG 16384u
#define TH_ZUPT 800000u
#define TH_ZARU 200u

// SETTINGS BIAS EST. AND COMP.
#define NLOG2Q 0
#define LOG2R 20
#define R_BIAS (1<<LOG2R)
#define LOG2PMAX (LOG2R-3)
#define PMAX ((1<<LOG2PMAX)-1)
#define LOG2GS (32-LOG2PMAX)
#define GS (1<<LOG2GS)
#define LOG2BS 5
#define BS (1<<LOG2BS)

#define BIAS_TIME_SCALE (0.0002f)
#define RF (0.02f)
#define QF (BIAS_TIME_SCALE*BIAS_TIME_SCALE*RF)

// SETTINGS/CALIBRATION MIMU
#define NR_IMU_SLOTS 32
#define FLOG2_NR_IMU 3u
#define NR_IMUS 18

#define GSCALE (3.24775742e-8f)
#define FSCALE (1.46180391e-7f)

#define ACC_BIAS { 0, 0, 0}
#define GYRO_BIAS { 0, 0, 0}
#define CALIBRATION_MATRIX \
{ \
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{ 18725,      0,      0,      0,  18725,      0,      0,      0,  18725,  18725,      0,      0,      0,  18725,      0,      0,      0,  18725,},\
	{     0, -18725,      0, -18725,      0,      0,      0,      0, -18725,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0, -18725,      0, -18725,      0,      0,      0,      0, -18725,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0, -18725,      0, -18725,      0,      0,      0,      0, -18725,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0, -18725,      0, -18725,      0,      0,      0,      0, -18725,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0, -18725,      0, -18725,      0,      0,      0,      0, -18725,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0, -18725,      0, -18725,      0,      0,      0,      0, -18725,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,}\
}

/*
{ \
	{ 18563,    216,   -166,   -217,  18589,      9,    168,     -9,  18839,  18725,    218,   -167,   -218,  18725,      9,    167,     -9,  18725,},\
	{ 18678,     55,   -130,    -55,  18621,    -96,    130,     97,  18759,  18725,     55,   -130,    -55,  18725,    -97,    130,     97,  18725,},\
	{ 18672,   -200,    -92,    201,  18719,   -101,     91,    100,  18622,  18725,   -201,    -92,    201,  18725,   -101,     92,    101,  18725,},\
	{ 18786,    551,   -157,   -546,  18609,    -24,    157,     24,  18815,  18725,    549,   -156,   -549,  18725,    -24,    156,     24,  18725,},\
	{ 18522,   -236,   -114,    240,  18793,   -211,    114,    208,  18515,  18725,   -239,   -115,    239,  18725,   -210,    115,    210,  18725,},\
	{ 18667,   -186,   -157,    186,  18614,     95,    157,    -95,  18619,  18725,   -187,   -158,    187,  18725,     95,    158,    -95,  18725,},\
	{ 18747,      9,   -166,     -9,  18740,   -140,    167,    140,  18780,  18725,      9,   -166,     -9,  18725,   -140,    166,    140,  18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{ 18576,    163,    -55,   -163,  18595,     10,     56,    -10,  18877,  18725,    165,    -56,   -165,  18725,     10,     56,    -10,  18725,},\
	{    23, -18743,     71, -18771,    -23,    100,    -99,    -70, -18562,     23, -18725,     71, -18725,    -23,    100,   -100,    -71, -18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{    90, -18750,    186, -18532,    -89,    202,   -201,   -183, -18459,     90, -18725,    186, -18725,    -90,    204,   -204,   -186, -18725,},\
	{   126, -18571,   -173, -18713,   -127,      4,     -4,    173, -18588,    127, -18725,   -175, -18725,   -127,      4,     -4,    175, -18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{   174, -18544,   -175, -18599,   -175,     32,    -32,    175, -18483,    176, -18725,   -177, -18725,   -176,     32,    -32,    177, -18725,},\
	{  -126, -18685,     56, -18746,    127,   -280,    280,    -57, -18805,   -127, -18725,     57, -18725,    127,   -279,    279,    -57, -18725,},\
	{     0, -18691,      0, -18586,      0,      0,      0,      0, -18679,      0, -18725,      0, -18725,      0,      0,      0,      0, -18725,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,},\
	{     0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,      0,}\
}
*/

#define NR_OF_INITIAL_ALIGNMENT_SAMPLES (N)

#define KALMAN_SIGMA_2_ACC (0.7f*0.7f)
#define KALMAN_SIGMA_2_GYRO (0.017f*0.017f)
#define KALMAN_SIGMA_2_ZUPT (0.1f*0.1f)
#define RESET_COV_THRESHOLD 0.0003f

#endif /* MIMU3333_H_ */